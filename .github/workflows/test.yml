name: build expo

on:
  push:
    branches: [ feature/home ]

jobs:
  update:
    name: EAS Update
    runs-on: ubuntu-latest
    steps:

      - name: checkout repository
        uses: actions/checkout@v3

      - name: create bookbla-2024-firebase-adminsdk.json
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "bookbla-2024-firebase-adminsdk-qfspu-1dcca92597.json"
          json: ${{ secrets.FIREBASE_JSON }}

      - name: create app.json
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "app.json"
          json: ${{ secrets.APP_JSON }}

      - name: create google-services.json
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "google-services.json"
          json: ${{ secrets.GOOGLE_SERVICES_JSON }}

      - name: create eas.json
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "eas.json"
          json: ${{ secrets.EAS_JSON }}

      - name: setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: npm
          cache-dependency-path: ./package-lock.json

      - name: setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: install dependencies
        run: npm install

      - name: publish update
        run: eas build -p all --profile local --non-interactive

      - name: reflect testflight
        run: eas submit -p ios --latest --profile local --non-interactive
